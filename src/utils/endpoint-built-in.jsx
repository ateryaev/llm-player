import { wait } from "./helpers";

const stories = [
    "In a small coastal town, an old lighthouse stood tall and proud, its beam of light guiding sailors safely to shore for generations. The lighthouse keeper, old Mr. Thompson, had been tending to the light for as long as anyone could remember. He was a quiet man, keeping to himself most of the time, but the townsfolk respected him and his dedication to his duty.\n\nOne stormy night, as the waves crashed against the rocks and the wind howled through the trees, Mr. Thompson noticed something unusual. The light, which had always been a steady and reliable beacon, began to flicker. He rushed up the spiral staircase to the top of the lighthouse, his heart pounding in his chest. As he reached the lantern room, he saw that the mechanism controlling the light was jammed. With a sense of urgency, he worked quickly to fix the problem, knowing that the lives of sailors depended on the light's steady glow. Just as he finished his repairs, he heard a faint cry for help coming from the sea. He grabbed his binoculars and scanned the dark waters, spotting a small boat being tossed about by the waves.\n\nWithout hesitation, he sounded the foghorn and sent out a distress signal, alerting the town's rescue team. The team arrived swiftly, and together they managed to save the stranded sailors, bringing them safely to shore. The townsfolk hailed Mr. Thompson as a hero, and the old lighthouse continued to stand as a symbol of hope and guidance for all who passed by.",

    "In the bustling city of New York, a young scientist named Dr. Emily Hart was on the verge of a groundbreaking discovery. She had been working tirelessly in her lab, experimenting with a new form of energy that could revolutionize the world. Her colleagues admired her dedication and brilliance, but some were skeptical of her ambitious goals.\n\nOne evening, as she was conducting her latest experiment, a sudden surge of energy filled the room. The machines hummed loudly, and the air crackled with electricity. Dr. Hart's heart raced as she realized that she had finally succeeded in creating a stable source of clean, limitless energy. She quickly documented her findings and shared them with her team, who were astonished by her achievement. News of her discovery spread rapidly, and soon the entire scientific community was buzzing with excitement.\n\nDr. Hart was invited to speak at conferences and seminars around the world, where she shared her vision for a future powered by her new energy source. Governments and corporations took notice, and investments poured in to support further research and development. Within a few years, Dr. Hart's energy revolution had transformed the world, reducing pollution and providing affordable power to millions of people. She became a symbol of hope and inspiration, proving that with determination and innovation, anything is possible.",

    "Deep in the heart of the Amazon rainforest, a group of adventurers set out on a daring expedition to find the legendary city of gold, El Dorado. Led by the fearless explorer, Captain Rodriguez, the team consisted of archaeologists, historians, and skilled guides who were determined to uncover the secrets of the ancient civilization.\n\nThe journey was treacherous, filled with dense jungle, treacherous rivers, and dangerous wildlife. But the adventurers pressed on, driven by their shared dream of discovering the fabled city. After weeks of arduous travel, they finally reached a hidden valley, shrouded in mist and mystery. As they ventured deeper into the valley, they came across ancient ruins, overgrown with vines and moss. The air was thick with the scent of history, and the adventurers could feel the weight of the centuries pressing down upon them.\n\nThey explored the ruins, uncovering artifacts and inscriptions that told the story of a once-great civilization. But the true prize lay at the heart of the valley, where a magnificent golden city stood, untouched by time. The adventurers marveled at the sight, their eyes wide with wonder and awe. They had found El Dorado, the city of gold, and with it, a piece of history that had been lost to the world for centuries.",

    "In the quiet town of Willow Creek, strange things began to happen at the old mansion on the hill. The once-grand estate had fallen into disrepair, and rumors of ghostly apparitions and eerie noises kept the townsfolk away. But when the Johnson family moved in, they were determined to restore the mansion to its former glory.\n\nLittle did they know, the mansion held dark secrets that would soon reveal themselves. One night, as the family settled in for the evening, they heard a faint whispering sound coming from the attic. The father, Mr. Johnson, decided to investigate, armed with a flashlight and a healthy dose of skepticism. As he climbed the creaky stairs to the attic, the whispering grew louder, and he could swear he heard his name being called. He pushed open the attic door and stepped inside, his heart pounding in his chest.\n\nThe room was filled with dusty old furniture and forgotten treasures, but it was the far corner that caught his eye. There, hidden behind a stack of boxes, was a small, ornate mirror. As Mr. Johnson approached the mirror, he saw a faint reflection that wasn't his own. It was the ghostly figure of a woman, her eyes filled with sadness and longing. He reached out to touch the mirror, and suddenly, the room was filled with a bright light. When the light faded, Mr. Johnson found himself standing in the same attic, but everything was different. The furniture was new, and the air was filled with the scent of fresh flowers. He turned to the mirror and saw the woman's reflection once again, but this time, she was smiling. He realized that he had been transported back in time, and the woman in the mirror was the mansion's original owner, who had been waiting for someone to set her spirit free.",

    "In the not-too-distant future, a brilliant scientist named Dr. Alexander discovered a way to make himself invisible. His groundbreaking invention, a serum that could bend light around the human body, had the potential to revolutionize the fields of espionage, medicine, and even entertainment. But Dr. Alexander soon realized that his newfound power came with a heavy price.\n\nAs he tested the serum on himself, he found that the effects were not only temporary but also unpredictable. Sometimes he would remain invisible for hours, while other times the serum would wear off in mere minutes. Worse still, the serum had side effects that he had not anticipated. His body began to change in ways he could not control, and he found himself becoming more and more isolated from the world around him. Desperate to reverse the effects of the serum, Dr. Alexander worked tirelessly in his lab, searching for a cure.\n\nBut as the days turned into weeks, and the weeks into months, he began to lose hope. He realized that he had become a prisoner of his own creation, trapped in a world where he could see and hear everything, but no one could see or hear him. In a moment of despair, he decided to share his story with the world, hoping that someone, somewhere, could help him find a way back to the life he once knew. He wrote a letter detailing his experiences and sent it to a trusted friend, who promised to share it with the scientific community. As the letter made its way around the world, Dr. Alexander's story captured the imagination of people everywhere, and a global effort was launched to find a cure for his condition. Though he remained invisible, Dr. Alexander found solace in the knowledge that he was not alone, and that there were people out there who cared about his fate.",

    "In the heart of Egypt, a team of archaeologists made a discovery that would change the course of history. While excavating a long-forgotten tomb, they uncovered a hidden chamber filled with treasures beyond their wildest dreams. Gold, jewels, and ancient artifacts lay scattered about, untouched by human hands for thousands of years.\n\nBut it was the sarcophagus at the center of the chamber that truly captured their attention. Carved from a single block of black granite, it was adorned with intricate hieroglyphs that told the story of a powerful pharaoh who had ruled over Egypt in a time of great prosperity. The archaeologists worked carefully to open the sarcophagus, their hearts pounding with anticipation. As the lid was finally lifted, they gasped in awe at the sight before them. The pharaoh's mummy lay perfectly preserved, his golden mask gleaming in the dim light of the chamber.\n\nBut as they leaned in for a closer look, something strange began to happen. The air grew cold, and a faint whispering sound filled the room. The hieroglyphs on the walls seemed to come to life, their symbols dancing and shifting before the archaeologists' eyes. Suddenly, a bright light filled the chamber, and the team found themselves transported back in time, standing before the pharaoh himself. He thanked them for freeing him from his eternal slumber and offered them a reward beyond their wildest dreams. But the archaeologists knew that they could not accept, for they had uncovered a secret that was never meant to be revealed. With heavy hearts, they returned to their own time, leaving the pharaoh's tomb as they had found it, a testament to the power and mystery of ancient Egypt.",

    "In the year 2050, Earth found itself under attack from an alien force unlike any it had ever encountered. The invaders, known as the Zetans, possessed technology far beyond that of humanity, and their ships filled the skies, raining destruction upon the cities below. Governments around the world scrambled to mount a defense, but it was clear that they were outmatched.\n\nIn a desperate bid to turn the tide of the war, a group of scientists and engineers came together to form the Earth Defense Force. Led by the brilliant Dr. Ada Chen, the team worked tirelessly to develop new weapons and strategies to combat the Zetan threat. Their first breakthrough came in the form of a powerful energy shield that could protect entire cities from the alien attacks. But they knew that defense alone would not be enough to win the war. They needed a way to strike back at the Zetans and drive them from Earth's skies.\n\nDr. Chen and her team turned their attention to the development of a new type of spacecraft, one that could match the speed and agility of the Zetan ships. They worked day and night, pouring their hearts and souls into the project, and finally, after months of tireless effort, they unveiled their creation: the Phoenix, a sleek and powerful fighter craft designed to take the fight to the enemy. With the Phoenix leading the charge, the Earth Defense Force launched a daring counterattack, catching the Zetans off guard and turning the tide of the war. Cities were liberated, and hope was restored to the people of Earth. Though the battle was far from over, humanity had taken its first steps towards reclaiming its home and securing its future among the stars.",

    "In a quiet corner of the countryside, a young girl named Lily discovered a hidden gate leading to a secret garden. The garden was overgrown and neglected, but Lily could see the beauty that lay beneath the weeds and tangled vines. She decided to make it her mission to restore the garden to its former glory, and so she set to work, pulling weeds, pruning bushes, and planting flowers.\n\nAs the days turned into weeks, and the weeks into months, the garden began to take shape. Lily's hard work paid off, and soon the garden was a riot of color and life, filled with the sweet scent of blooming flowers and the gentle hum of bees. But Lily soon realized that the garden held a secret, one that went far beyond its beauty. As she tended to the plants, she noticed that they seemed to respond to her touch, growing stronger and more vibrant with each passing day. She began to experiment, talking to the plants and singing to them, and to her amazement, they seemed to understand.\n\nThe garden became a place of magic and wonder, where Lily could escape the troubles of the world and lose herself in the beauty of nature. She shared her discovery with her friends, who were equally amazed by the garden's enchanting qualities. Together, they worked to protect and preserve the garden, ensuring that its magic would be enjoyed by generations to come. And so, the secret garden became a symbol of hope and renewal, a testament to the power of nature and the indomitable spirit of those who tend to it.",

    "In the vast expanse of the ocean, a crew of sailors found themselves adrift on a ghostly ship, its sails tattered and its decks creaking with the weight of the centuries. The ship, known as the Flying Dutchman, was said to be cursed, doomed to sail the seas for all eternity, never able to make port or find rest.\n\nThe sailors, led by the brave Captain Harris, had set out on a routine voyage, but a sudden storm had blown them off course, and they found themselves lost in the fog, with no land in sight. As they drifted aimlessly, they began to notice strange occurrences on board the ship. Ghostly figures appeared and disappeared, and the sound of distant voices echoed through the mist. The crew grew uneasy, and some began to speak of mutiny, but Captain Harris remained steadfast, determined to see his ship and his men safely to shore.\n\nOne night, as the fog lifted and the moon shone brightly overhead, the crew spotted a distant light on the horizon. With renewed hope, they set a course for the light, praying that it would lead them to safety. As they drew closer, they saw that the light came from a lighthouse, its beam cutting through the darkness like a beacon of hope. With a final burst of speed, the ship sailed towards the lighthouse, and as it drew near, the crew saw a figure standing on the shore, waving them in. It was the lighthouse keeper, who had seen their plight and guided them to safety. With gratitude in their hearts, the sailors stepped onto dry land, their ordeal finally at an end. The Flying Dutchman, it seemed, had found its way home at last.",

    "In a world where time travel was a reality, a young man named Ethan found himself faced with a difficult choice. He had been given the power to travel through time, to witness the great events of history and to shape the course of the future. But with great power came great responsibility, and Ethan knew that his actions could have far-reaching consequences.\n\nHe had been sent on a mission to the past, to prevent a catastrophic event that would change the course of history forever. But as he journeyed back in time, he began to question the wisdom of his mission. What right did he have to interfere with the natural order of things? And what if his actions only made things worse? As he grappled with these questions, Ethan found himself drawn into a web of intrigue and deception, where friends and enemies were not always what they seemed. He met people from different eras, each with their own agendas and motivations, and he began to see the complex tapestry of history in a new light.\n\nIn the end, Ethan realized that the true power of time travel lay not in changing the past, but in understanding it, and in using that understanding to shape a better future. He returned to his own time, his mission unfulfilled, but his heart filled with a newfound sense of purpose. He knew that he could not change the past, but he could learn from it, and use that knowledge to make a difference in the present. And so, Ethan became a guardian of time, a protector of the past, and a beacon of hope for the future."
];

function splitTextIntoRandomChunks(text) {
    const chunks = [];
    let remainingText = text;

    while (remainingText.length > 0) {
        const chunkSize = Math.floor(Math.random() * 10) + 15; // Random size between 10 and 15
        const chunk = remainingText.slice(0, chunkSize);
        chunks.push(chunk);
        remainingText = remainingText.slice(chunkSize);
    }

    return chunks;
}

class BuiltInApi {

    async loadModelList() {
        await wait(1000);
        return [
            { name: "built-in-story-teller", },
            { name: "built-in-echo-response", },
            { name: "built-in-story-with-error", }
        ];
    }

    #chunks = [];
    #finishReason = null;

    lastFinishReason() {
        return this.#finishReason;
    }

    abortLoadingModels() {
    }

    abortLoadingChat() {
        this.#chunks = null;
    }

    #modelName = null;
    #lastMessage = null;
    lastFinnishReason() {
        return this.#finishReason;
    }
    continueChatStart(url, modelName, messages, config) {
        //create fetch promise from arguments
        const story = stories[Math.floor(Math.random() * stories.length)];
        this.#chunks = splitTextIntoRandomChunks(story).reverse();
        this.#modelName = modelName;
        this.#finishReason = null;
        this.#lastMessage = messages[messages.length - 1].content;
    }

    async continueChatLoader() {
        // return null if finished or not started
        // return next text from the response

        if (this.#chunks.length === 0) return null;

        await wait(Math.floor(Math.random() * 500 + 100));

        if (!this.#chunks) {
            throw new Error("Chat generation aborted!");
        }

        if (this.#modelName === "built-in-story-teller") {
            if (this.#chunks.length < 2) this.#finishReason = "stop";
            return this.#chunks.pop();
        }

        if (this.#modelName === "built-in-story-with-error") {
            if (Math.random() > 0.95 || this.#chunks.length < 10) {
                throw new Error("built-in-story-with-error always throw error in the middle!");
            }
            return this.#chunks.pop();
        }

        if (this.#modelName === "built-in-echo-response") {
            this.#finishReason = "stop";
            this.#chunks = [];
            return "You said:\n" + this.#lastMessage;
        }

        throw new Error(`Unknown built-in model name: ${this.#modelName}`);
    }
}

export default BuiltInApi;
